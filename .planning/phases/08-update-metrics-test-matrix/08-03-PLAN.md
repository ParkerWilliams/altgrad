---
phase: 08-update-metrics-test-matrix
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - altgrad/quantization/rank_health.py
  - tests/test_rank_health.py
autonomous: true

must_haves:
  truths:
    - "Classifier layers (lm_head, c_proj) use stricter threshold than other layers"
    - "critical_threshold_multiplier parameter controls stricter threshold (default 0.5x)"
    - "Per-layer threshold accessible via _get_threshold_for_layer method"
    - "Early warning fires earlier for classifier layers than for other layers"
  artifacts:
    - path: "altgrad/quantization/rank_health.py"
      provides: "RankHealthMonitor with classifier-specific thresholds"
      contains: "critical_threshold_multiplier"
    - path: "tests/test_rank_health.py"
      provides: "Tests for classifier-specific monitoring"
      contains: "test_classifier_stricter"
  key_links:
    - from: "altgrad/quantization/rank_health.py"
      to: "layer name patterns"
      via: "any(pattern in name for pattern)"
      pattern: "critical_layers.*lm_head"
---

<objective>
Enhance RankHealthMonitor with configurable classifier-specific stricter thresholds

Purpose: Classifier layers (lm_head, c_proj) are critical for model output - they need earlier warning on rank collapse than internal layers
Output: RankHealthMonitor with critical_threshold_multiplier parameter and documented stricter thresholds for classifier layers
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-update-metrics-test-matrix/08-RESEARCH.md

# Existing implementation to enhance
@altgrad/quantization/rank_health.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add critical_threshold_multiplier to RankHealthMonitor</name>
  <files>altgrad/quantization/rank_health.py</files>
  <action>
Enhance RankHealthMonitor with explicit configurable classifier thresholds:

1. Update __init__ signature:
   ```python
   def __init__(
       self,
       log_interval: int = 100,
       warn_threshold: float = 0.3,
       critical_layers: Optional[List[str]] = None,
       critical_threshold_multiplier: float = 0.5,
   ):
   ```

2. Store new parameter:
   ```python
   self.critical_threshold_multiplier = critical_threshold_multiplier
   ```

3. Add public method `get_threshold_for_layer(self, name: str) -> float`:
   ```python
   def get_threshold_for_layer(self, name: str) -> float:
       """Return warning threshold for a layer.

       Critical layers (lm_head, c_proj by default) use a stricter threshold
       to provide earlier warning of rank collapse in output-critical layers.

       Args:
           name: Layer parameter name

       Returns:
           Warning threshold (fraction drop that triggers warning)
           - critical_layers: warn_threshold * critical_threshold_multiplier
           - other layers: warn_threshold

       Example:
           >>> monitor = RankHealthMonitor(warn_threshold=0.3, critical_threshold_multiplier=0.5)
           >>> monitor.get_threshold_for_layer("lm_head.weight")  # Returns 0.15
           >>> monitor.get_threshold_for_layer("encoder.layer.0.weight")  # Returns 0.3
       """
       is_critical = any(pattern in name for pattern in self.critical_layers)
       if is_critical:
           return self.warn_threshold * self.critical_threshold_multiplier
       return self.warn_threshold
   ```

4. Update check_warnings to use get_threshold_for_layer:
   The existing code already does this implicitly with `threshold = self.warn_threshold * 0.5 if is_critical else self.warn_threshold`
   Change to: `threshold = self.get_threshold_for_layer(name)`

5. Update docstrings to document:
   - critical_threshold_multiplier parameter (default 0.5)
   - Default critical_layers = ["lm_head", "c_proj"]
   - Example: 0.3 warn_threshold * 0.5 multiplier = 0.15 for classifiers

6. Add docstring clarification to class:
   ```
   Classifier-Specific Monitoring:
       Critical layers like lm_head and c_proj receive stricter threshold
       monitoring. With default settings (warn_threshold=0.3, multiplier=0.5),
       classifiers warn at 15% drop vs 30% for other layers.
   ```
  </action>
  <verify>
Run: `python -c "from altgrad.quantization.rank_health import RankHealthMonitor; m = RankHealthMonitor(); print('lm_head threshold:', m.get_threshold_for_layer('lm_head.weight')); print('other threshold:', m.get_threshold_for_layer('encoder.layer.weight'))"`
Expected: lm_head threshold: 0.15, other threshold: 0.3
  </verify>
  <done>
RankHealthMonitor has critical_threshold_multiplier parameter and get_threshold_for_layer() public method returning stricter threshold for classifier layers
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for classifier-specific thresholds</name>
  <files>tests/test_rank_health.py</files>
  <action>
Add tests for classifier-specific threshold behavior:

1. `test_get_threshold_for_layer_critical()`:
   - Create monitor with warn_threshold=0.3, critical_threshold_multiplier=0.5
   - Verify get_threshold_for_layer("lm_head.weight") == 0.15
   - Verify get_threshold_for_layer("c_proj.weight") == 0.15

2. `test_get_threshold_for_layer_non_critical()`:
   - Create monitor with warn_threshold=0.3, critical_threshold_multiplier=0.5
   - Verify get_threshold_for_layer("encoder.layer.0.weight") == 0.3
   - Verify get_threshold_for_layer("mlp.fc1.weight") == 0.3

3. `test_critical_threshold_multiplier_custom()`:
   - Create monitor with critical_threshold_multiplier=0.25
   - Verify get_threshold_for_layer("lm_head.weight") == 0.075 (0.3 * 0.25)

4. `test_check_warnings_uses_stricter_threshold()`:
   - Create monitor and model with "lm_head" layer
   - Set initial rank, then simulate drop of 20%
   - For lm_head (threshold 0.15): should warn
   - For other layer (threshold 0.30): should NOT warn
   - This tests that check_warnings() uses the correct per-layer threshold

5. `test_custom_critical_layers()`:
   - Create monitor with critical_layers=["classifier", "output"]
   - Verify "classifier.weight" gets stricter threshold
   - Verify "lm_head.weight" does NOT get stricter threshold (not in list)
  </action>
  <verify>
Run: `pytest tests/test_rank_health.py -v -k "threshold or critical" --tb=short`
Expected: All 5 new tests pass
  </verify>
  <done>
5 new tests covering classifier-specific threshold behavior all pass
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/test_rank_health.py -v --tb=short` - All tests pass (existing + new)
2. `python -c "from altgrad.quantization import RankHealthMonitor"` - Import works
3. Verify threshold difference: `python -c "from altgrad.quantization.rank_health import RankHealthMonitor; m = RankHealthMonitor(); assert m.get_threshold_for_layer('lm_head.w') < m.get_threshold_for_layer('other.w')"`
</verification>

<success_criteria>
- RankHealthMonitor.__init__ accepts critical_threshold_multiplier (default 0.5)
- get_threshold_for_layer(name) returns stricter threshold for critical layers
- Default critical_layers = ["lm_head", "c_proj"]
- check_warnings() uses per-layer threshold from get_threshold_for_layer()
- All tests pass including 5 new classifier threshold tests
</success_criteria>

<output>
After completion, create `.planning/phases/08-update-metrics-test-matrix/08-03-SUMMARY.md`
</output>
