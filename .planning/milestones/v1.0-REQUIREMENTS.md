# Requirements Archive: v1.0 Research Infrastructure

**Archived:** 2026-01-26
**Status:** SHIPPED

This is the archived requirements specification for v1.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: AltGrad

**Defined:** 2026-01-20
**Core Value:** Evidence-backed answer to which 8-bit floating-point format most benefits from geometry-aware updates, and why.

## v1 Requirements

Requirements for initial release. Each maps to roadmap phases.

### Quantization Engine

- [x] **QUANT-01**: FP8 format registry supporting E0M7, E1M6, E3M4, E5M2, E7M0 specifications
- [x] **QUANT-02**: Quantize/dequantize functions with Straight-Through Estimator gradient override
- [x] **QUANT-03**: Per-tensor scaling with delayed amax tracking (history buffer)
- [x] **QUANT-04**: Format-specific transfer functions (bit-index <-> real value)

### Stability Monitoring

- [x] **STAB-01**: Per-tensor overflow/underflow counters (forward, backward, optimizer)
- [x] **STAB-02**: NaN/Inf detection with configurable early stopping
- [x] **STAB-03**: Dynamic range tracking (amax moving average)
- [x] **STAB-04**: Bit-Stall counter (tracks when `round(b + delta_b) == b` despite non-zero gradient)
- [x] **STAB-05**: Partition-relative gradient clipping (clip based on format's dynamic range)
- [x] **STAB-06**: Emergency mantissa shift (increase M bits on persistent NaN/high stall rate)

### Training Metrics

- [x] **METR-01**: Train/validation loss logging per step/epoch
- [x] **METR-02**: Perplexity tracking for language modeling quality
- [x] **METR-03**: Wall-clock time and throughput (tokens/sec)
- [x] **METR-04**: BF16 baseline comparison plots (automated)
- [x] **METR-05**: Gradient cosine similarity (FP8 vs FP32 reference, periodic)

### Gradient Statistics

- [x] **GRAD-01**: Per-layer gradient norms (L2, Linf)
- [x] **GRAD-02**: Gradient SNR (FP8 vs FP32 reference)
- [x] **GRAD-03**: Dead neuron fraction detection
- [x] **GRAD-04**: Zero-update fraction tracking (weights that didn't change)

### Model Integration

- [x] **INTG-01**: QuantizedLinear wrapper layer (inject quantization without forking nanoGPT)
- [x] **INTG-02**: `quantize_model()` surgery function for post-init layer replacement
- [x] **INTG-03**: Per-layer mixed precision config (attention in BF16, MLP in FP8)
- [x] **INTG-04**: EurLex dataset integration with nanoGPT training loop

### Manifold-Aware Optimizer

- [x] **MANI-01**: Stiffness factor calculation: `S = 2^(floor(log2|w|) - M)`
- [x] **MANI-02**: Stiffness-preconditioned gradient step (`grad *= S` before update)
- [x] **MANI-03**: Standard vs manifold-aware training mode toggle
- [x] **MANI-04**: Bit-position tracking (latent integer state for each weight)

### Manifold Diagnostics

- [x] **DIAG-01**: Stiffness field visualization (per-weight S values over training)
- [x] **DIAG-02**: Quantization grid alignment measurement (distance to nearest FP8 value)
- [x] **DIAG-03**: Gradient-stiffness correlation analysis
- [x] **DIAG-04**: ULP statistics (how many bit-positions each update moves)

### Experiment Infrastructure

- [x] **EXPR-01**: YAML/JSON experiment config grid
- [x] **EXPR-02**: Per-run logging (W&B integration)
- [x] **EXPR-03**: Checkpoint management with restart capability
- [x] **EXPR-04**: Format ablation runs (identical seeds/ordering across formats)

### Analysis Output

- [x] **ANAL-01**: Summary analysis identifying sweet-spot format per layer type
- [x] **ANAL-02**: Failure mode documentation (where each format fails: forward, backward, optimizer)
- [x] **ANAL-03**: Manifold-aware vs standard comparison report

### Flip Metrics

- [x] **FLIP-01**: Weight flip counting (track when quantized weights change FP8 representation)
- [x] **FLIP-02**: Flip rate per layer/step/epoch with W&B logging

### Rank Health Monitoring

- [x] **RANK-01**: Stable rank computation: ||W||_F² / ||W||_2² for weight matrices
- [x] **RANK-02**: Effective rank tracking (singular values needed for 99% variance)
- [x] **RANK-03**: Rank collapse early warning (detect downward trends before catastrophic collapse)

### Update Metrics

- [x] **UPDT-01**: Weight update counting (non-zero gradient applied, distinct from flip count)
- [x] **UPDT-02**: Stall ratio computation (1 - flips/updates) to quantify gradient effectiveness

### Grid-Based Optimizer

- [x] **GRID-01**: Grid-based (rung) optimizer with stochastic rounding and rung clipping
- [x] **GRID-02**: Master weights in FP32 with FP8 projection for grid-aware updates

### Classifier Rank Monitoring

- [x] **CLSF-01**: Classifier-specific (lm_head, c_proj) rank health tracking with stricter thresholds

### Experiment Documentation

- [x] **MTRIX-01**: TEST_MATRIX.md documenting all format × optimizer × layer combinations

## v2 Requirements

Deferred to future release. Tracked but not in current roadmap.

### Advanced Diagnostics

- **DIAG-05**: Hessian eigenvalue spectrum (expensive, sample periodically)
- **DIAG-06**: Bit-space uniformity analysis (delta_bit vs delta_w tracking)
- **DIAG-07**: Format capacity utilization (which FP8 values actually used)

### Automation

- **AUTO-01**: Format-specific stability threshold detection (auto LR sweep)
- **AUTO-02**: Comparative dynamics dashboard (live parallel coordinates)

## Out of Scope

Explicitly excluded. Documented to prevent scope creep.

| Feature | Reason |
|---------|--------|
| Distributed training | Single H100 constraint |
| Production/inference optimization | Research test bench, not deployment |
| Automatic hyperparameter tuning | $20 budget limits sweep runs |
| Multiple optimizer baselines | Focus on AdamW + manifold-aware only |
| Data preprocessing pipelines | Use EurLex as-is to avoid confounds |
| Architectural stability hacks (SmoothSwiGLU, etc.) | Want raw format behavior, not masked |
| Full convergence runs | Short runs sufficient for trend visibility |
| Gradient-only quantization | Defer unless needed |
| Optimizer state quantization | Defer unless needed |

## Traceability

Which phases cover which requirements. Updated during roadmap creation.

| Requirement | Phase | Status |
|-------------|-------|--------|
| QUANT-01 | Phase 1 | Complete |
| QUANT-02 | Phase 1 | Complete |
| QUANT-03 | Phase 1 | Complete |
| QUANT-04 | Phase 1 | Complete |
| STAB-01 | Phase 2 | Complete |
| STAB-02 | Phase 2 | Complete |
| STAB-03 | Phase 2 | Complete |
| STAB-04 | Phase 1 | Complete |
| STAB-05 | Phase 4 | Complete |
| STAB-06 | Phase 4 | Complete |
| METR-01 | Phase 2 | Complete |
| METR-02 | Phase 2 | Complete |
| METR-03 | Phase 2 | Complete |
| METR-04 | Phase 2 | Complete |
| METR-05 | Phase 2 | Complete |
| GRAD-01 | Phase 2 | Complete |
| GRAD-02 | Phase 2 | Complete |
| GRAD-03 | Phase 2 | Complete |
| GRAD-04 | Phase 2 | Complete |
| INTG-01 | Phase 3 | Complete |
| INTG-02 | Phase 3 | Complete |
| INTG-03 | Phase 3 | Complete |
| INTG-04 | Phase 2 | Complete |
| MANI-01 | Phase 5 | Complete |
| MANI-02 | Phase 5 | Complete |
| MANI-03 | Phase 5 | Complete |
| MANI-04 | Phase 5 | Complete |
| DIAG-01 | Phase 4 | Complete |
| DIAG-02 | Phase 4 | Complete |
| DIAG-03 | Phase 4 | Complete |
| DIAG-04 | Phase 4 | Complete |
| EXPR-01 | Phase 2 | Complete |
| EXPR-02 | Phase 2 | Complete |
| EXPR-03 | Phase 2 | Complete |
| EXPR-04 | Phase 3 | Complete |
| ANAL-01 | Phase 6 | Complete |
| ANAL-02 | Phase 6 | Complete |
| ANAL-03 | Phase 6 | Complete |
| FLIP-01 | Phase 7 | Complete |
| FLIP-02 | Phase 7 | Complete |
| RANK-01 | Phase 7 | Complete |
| RANK-02 | Phase 7 | Complete |
| RANK-03 | Phase 7 | Complete |
| UPDT-01 | Phase 8 | Complete |
| UPDT-02 | Phase 8 | Complete |
| GRID-01 | Phase 8 | Complete |
| GRID-02 | Phase 8 | Complete |
| CLSF-01 | Phase 8 | Complete |
| MTRIX-01 | Phase 8 | Complete |

**Coverage:**
- v1 requirements: 50 total
- Mapped to phases: 50
- Unmapped: 0
- Complete: 50

---

## Milestone Summary

**Shipped:** 50 of 50 v1 requirements
**Adjusted:** None - all requirements implemented as specified
**Dropped:** None

---

*Archived: 2026-01-26 as part of v1.0 milestone completion*
